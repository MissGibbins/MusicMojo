<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MusicMojo</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background: white;
      padding: 10px;
      display: flex;
      align-items: center;
      border-bottom: 2px solid #ccc;
    }
    header img {
      height: 80px;
      margin-right: 15px;
    }
    header button, header select {
      margin-right: 10px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #aaa;
      background: #f5f5f5;
      cursor: pointer;
    }
    #studentCanvas {
      position: relative;
      width: 100%;
      height: calc(100vh - 120px);
      background: #f9f9f9;
      overflow: hidden;
    }
    .student {
      width: 120px;
      height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: 2px solid #444;
      border-radius: 8px;
      font-weight: bold;
      position: absolute;
      cursor: grab;
      user-select: none;
    }
    .student:active {
      cursor: grabbing;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 250px;
    }
    .modal-content label {
      display: block;
      margin: 8px 0 4px;
    }
    .modal-content input {
      width: 100%;
      padding: 6px;
      margin-bottom: 10px;
    }
    .close {
      float: right;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <img src="MusicMojo logo.png" alt="MusicMojo Logo">
    <button onclick="newClass()">New Class</button>
    <button onclick="addStudent()">Add Student</button>
    <button onclick="saveStudents()">Save</button>
    <select id="classSelect" onchange="switchClass(this.value)">
      <option value="">-- Select Class --</option>
    </select>
  </header>

  <main>
    <div id="studentCanvas"></div>
  </main>

  <!-- Modal -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Edit Student</h3>
      <label>Name</label>
      <input type="text" id="modalName">
      <label>Color</label>
      <input type="color" id="modalColor">
      <button onclick="saveModal()">Save</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwxI2uWjYvoNo5EBILbVBQCe9wwmVjoDO1CpqTHSLo175DI2ar5cRURVX16--o5Ip7r/exec"; 

    let classes = {};
    let currentClass = "";
    let currentStudent = null;

    // --- API Helpers ---
    async function apiPost(data){
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      return res.json();
    }

    async function loadStudents(){
      try {
        const data = await apiPost({ type: "getStudents" });
        classes = {};
        data.forEach(s=>{
          if(!classes[s.Class]) classes[s.Class] = [];
          classes[s.Class].push(s);
        });
        populateClassSelect();
        renderStudents();
      } catch(err){
        console.error("Failed to load students:", err);
      }
    }

    async function saveStudents(){
      let students = [];
      Object.keys(classes).forEach(cls=>{
        classes[cls].forEach(s=>{
          students.push(s);
        });
      });
      await apiPost({ type: "saveStudents", students });
      console.log("Saved!");
    }

    // --- UI Logic ---
    function populateClassSelect(){
      const sel = document.getElementById("classSelect");
      sel.innerHTML = '<option value="">-- Select Class --</option>';
      Object.keys(classes).forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        if(c === currentClass) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function switchClass(name){
      currentClass = name;
      renderStudents();
    }

    function newClass(){
      const name = prompt("Enter class name:");
      if(name && !classes[name]){
        classes[name] = [];
        currentClass = name;
        populateClassSelect();
        renderStudents();
        saveStudents();
      }
    }

    function addStudent(){
      if(!currentClass){
        alert("Select a class first!");
        return;
      }
      const list = classes[currentClass];
      const student = {
        Class: currentClass,
        Name: "New Student",
        Number: list.length+1,
        Color: "lightgreen",
        X: 20, Y: 20
      };
      list.push(student);
      renderStudents();
      saveStudents();
    }

    function renderStudents(){
      const canvas = document.getElementById("studentCanvas");
      canvas.innerHTML = "";
      if(!currentClass || !classes[currentClass]) return;
      classes[currentClass].forEach((s,i)=>{
        const div = document.createElement("div");
        div.className = "student";
        div.style.background = s.Color || "lightgreen";
        div.style.left = (s.X || 20) + "px";
        div.style.top = (s.Y || 20) + "px";
        div.style.position = "absolute";
        div.dataset.index = i;
        div.innerHTML = `<span>${s.Name}</span><span>${s.Number}</span>`;

        // Dragging
        let offsetX, offsetY;
        div.addEventListener("mousedown", e=>{
          offsetX = e.clientX - div.offsetLeft;
          offsetY = e.clientY - div.offsetTop;

          function onMouseMove(e2){
            div.style.left = (e2.clientX - offsetX) + "px";
            div.style.top = (e2.clientY - offsetY) + "px";
          }

          function onMouseUp(e2){
            document.removeEventListener("mousemove", onMouseMove);
            document.removeEventListener("mouseup", onMouseUp);
            // save new pos
            s.X = parseInt(div.style.left);
            s.Y = parseInt(div.style.top);
            saveStudents();
          }

          document.addEventListener("mousemove", onMouseMove);
          document.addEventListener("mouseup", onMouseUp);
        });

        // Double-click to edit
        div.addEventListener("dblclick", ()=>openModal(s));

        canvas.appendChild(div);
      });
    }

    // --- Modal ---
    function openModal(student){
      currentStudent = student;
      document.getElementById("modalName").value = student.Name;
      document.getElementById("modalColor").value = student.Color;
      document.getElementById("studentModal").style.display = "flex";
    }
    function closeModal(){
      document.getElementById("studentModal").style.display = "none";
    }
    function saveModal(){
      if(currentStudent){
        currentStudent.Name = document.getElementById("modalName").value;
        currentStudent.Color = document.getElementById("modalColor").value;
        saveStudents();
        renderStudents();
        closeModal();
      }
    }

    window.onload = loadStudents;
  </script>
</body>
</html>
