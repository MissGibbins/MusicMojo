<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MusicMojo</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    #student-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .student {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .green { background: lightgreen; }
    .yellow { background: khaki; }
    .red { background: lightcoral; }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      text-align: center;
    }
    .color-options button {
      margin: 5px;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>MusicMojo</h1>
    <button id="new-class" style="margin-left:20px;">+ New Class</button>
  </header>

  <div id="student-container"></div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>Edit Student</h2>
      <input type="text" id="student-name" placeholder="Name"><br><br>
      <input type="number" id="student-number" placeholder="Number"><br><br>
      <div class="color-options">
        <button style="background:lightgreen" data-color="green">Green</button>
        <button style="background:khaki" data-color="yellow">Yellow</button>
        <button style="background:lightcoral" data-color="red">Red</button>
      </div>
      <br>
      <button id="save-student">Save</button>
      <button id="close-modal">Cancel</button>
    </div>
  </div>

  <script>
    const API_URL = "YOUR_GOOGLE_SCRIPT_WEBAPP_URL"; // <-- replace with your deployed script URL
    let students = [];
    let selectedStudentIndex = null;

    // Google Apps Script POST wrapper
    async function apiPost(data) {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      });
      return await res.json();
    }

    async function saveStudents() {
      await apiPost({ type: "saveStudents", students });
    }

    async function loadStudents() {
      try {
        const res = await apiPost({ type: "getStudents" });
        students = res;

        // If sheet empty, create default students
        if (!students || students.length === 0) {
          students = [];
          for (let i = 1; i <= 14; i++) {
            students.push({ name: "Student " + i, number: i, color: "green" });
          }
          await saveStudents();
        }

        renderStudents();
      } catch (err) {
        console.error("Failed to load students:", err);
      }
    }

    function renderStudents() {
      const container = document.getElementById("student-container");
      container.innerHTML = "";
      students.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "student " + s.color;
        div.innerHTML = `<strong>${s.name}</strong><br>#${s.number}`;
        div.onclick = () => openModal(i);
        container.appendChild(div);
      });
    }

    // Modal handling
    function openModal(index) {
      selectedStudentIndex = index;
      document.getElementById("student-name").value = students[index].name;
      document.getElementById("student-number").value = students[index].number;
      document.getElementById("modal").style.display = "flex";
    }
    function closeModal() {
      document.getElementById("modal").style.display = "none";
      selectedStudentIndex = null;
    }

    document.getElementById("save-student").onclick = async () => {
      if (selectedStudentIndex !== null) {
        students[selectedStudentIndex].name = document.getElementById("student-name").value;
        students[selectedStudentIndex].number = parseInt(document.getElementById("student-number").value);
        await saveStudents();
        renderStudents();
        closeModal();
      }
    };

    document.querySelectorAll(".color-options button").forEach(btn => {
      btn.onclick = async () => {
        if (selectedStudentIndex !== null) {
          students[selectedStudentIndex].color = btn.dataset.color;
          await saveStudents();
          renderStudents();
          closeModal();
        }
      };
    });

    document.getElementById("close-modal").onclick = closeModal;

    // New class button
    document.getElementById("new-class").onclick = async () => {
      if (confirm("Start a new class? This will overwrite existing data.")) {
        students = [];
        for (let i = 1; i <= 14; i++) {
          students.push({ name: "Student " + i, number: i, color: "green" });
        }
        await saveStudents();
        renderStudents();
      }
    };

    // Load students on page load
    loadStudents();
  </script>
</body>
</html>
