<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MusicMojo</title>
<style>
body { font-family: sans-serif; margin: 20px; }
header { display: flex; align-items: center; margin-bottom: 10px; }
header img { height: 100px; margin-right: 20px; }
header h1 { font-size: 32px; margin: 0; }
#classSelector { margin-bottom: 20px; }
#canvas { position: relative; width: 100%; height: 600px; border: 2px dashed #ccc; }
.student { width: 100px; height: 80px; background-color: #22C55F; color: white; display: flex; justify-content: center; align-items: center; cursor: grab; user-select: none; position: absolute; flex-direction: column; border-radius: 8px; font-size: 18px; text-align: center; padding: 10px; }
.yellow { background-color: #facc15; color: #000; }
.red { background-color: #ef4444; color: #fff; }
.actionBtn { background-color: #22C55F; color: white; border: none; padding: 8px 14px; margin-left: 8px; border-radius: 6px; cursor: pointer; font-size: 14px; }
.actionBtn:hover { background-color: #16a34a; }
#reasonModal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); display:none; justify-content: center; align-items: center; }
#reasonModalContent { background: #fff; padding: 20px; border-radius: 12px; width: 320px; text-align: center; }
.reasonBtn { display: block; margin: 10px auto; width: 220px; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
.greenBtn { background: #22C55F; color: #fff; }
.yellowBtn { background: #facc15; color: #000; }
.redBtn { background: #ef4444; color: #fff; }
#renameInput, #numberInput { width: 90%; padding: 5px; margin:5px 0; }
#renameBtn, #numberBtn { padding:5px 10px; margin-bottom:5px; cursor:pointer; }
</style>
</head>
<body>

<header>
<img src="MusicMojo logo.png" alt="MusicMojo Logo">
<h1>MusicMojo</h1>
</header>

<label for="classSelector">Select Class:</label>
<select id="classSelector"></select>
<button id="newClass" class="actionBtn">+ New Class</button>
<button id="addStudent" class="actionBtn">+ Add Student</button>

<div id="canvas"></div>

<!-- Modal -->
<div id="reasonModal">
<div id="reasonModalContent">
<h3 id="modalStudentName"></h3>
<!-- Color buttons -->
<button class="reasonBtn greenBtn" data-action="green">Back to Green</button>
<button class="reasonBtn yellowBtn" data-action="yellow">Follow Directions</button>
<button class="reasonBtn yellowBtn" data-action="yellow">Be Respectful</button>
<button class="reasonBtn yellowBtn" data-action="yellow">Be Responsible</button>
<button class="reasonBtn yellowBtn" data-action="yellow">Show What You Know</button>
<button class="reasonBtn redBtn" data-action="red">Reflection / Contact Home</button>
<!-- Rename and number -->
<input type="text" id="renameInput" placeholder="New Name">
<button id="renameBtn">Rename</button>
<input type="number" id="numberInput" placeholder="New Number">
<button id="numberBtn">Set Number</button>
<button id="closeModal" class="actionBtn">Close</button>
</div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyxJP348mWtExUVYAuttE0BMQPWnQESzUIH0kpir0XSOFQWE8DmXMwCuvIFye1_RlDE/exec"; 

const classSelector = document.getElementById("classSelector");
const newClassBtn = document.getElementById("newClass");
const addStudentBtn = document.getElementById("addStudent");
const canvas = document.getElementById("canvas");
const reasonModal = document.getElementById("reasonModal");
const modalStudentName = document.getElementById("modalStudentName");
const colorButtons = document.querySelectorAll(".reasonBtn");
const renameInput = document.getElementById("renameInput");
const renameBtn = document.getElementById("renameBtn");
const numberInput = document.getElementById("numberInput");
const numberBtn = document.getElementById("numberBtn");
const closeModal = document.getElementById("closeModal");

let classes = {};
let currentClass = "";
let selectedStudent = null;

// Helper: POST to Google Sheets
async function apiPost(payload){
  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  return res.json();
}

// Load students from Sheets
async function loadStudents(){
  try {
    const data = await apiPost({type:"getStudents"});
    classes = {};
    if(data.length === 0){
      // default class if sheet empty
      classes["Class 1"] = [];
      for(let i=1;i<=14;i++){
        classes["Class 1"].push({name:"Student "+i, number:i, color:"green", x:50+i*10, y:50});
      }
      await saveStudents();
    } else {
      data.forEach(s=>{
        if(!classes[s.Class]) classes[s.Class]=[];
        classes[s.Class].push(s);
      });
    }
    buildDropdown();
  } catch(err){
    console.error("Failed to load students:", err);
  }
}

// Save all students to Sheets
async function saveStudents(){
  try {
    await apiPost({type:"saveStudents", students: Object.values(classes).flat()});
  } catch(err){
    console.error("Failed to save students:", err);
  }
}

function buildDropdown(){
  classSelector.innerHTML="";
  Object.keys(classes).forEach(cls=>{
    const option=document.createElement("option");
    option.value=cls;
    option.textContent=cls;
    classSelector.appendChild(option);
  });
  currentClass=classSelector.value||Object.keys(classes)[0];
  renderStudents();
}

classSelector.addEventListener("change", ()=>{ 
  currentClass = classSelector.value; 
  renderStudents(); 
});

newClassBtn.addEventListener("click", async ()=>{
  const name=prompt("New class name:");
  if(!name || classes[name]) return alert("Invalid or duplicate class name!");
  classes[name]=[];
  currentClass=name;
  buildDropdown();
  await saveStudents();
});

addStudentBtn.addEventListener("click", async ()=>{
  const students=classes[currentClass];
  const newStudent={name:"New Student", number:students.length+1, color:"green", x:50, y:50};
  students.push(newStudent);
  await saveStudents();
  renderStudents();
});

function renderStudents(){
  canvas.innerHTML="";
  const students=classes[currentClass]||[];
  students.forEach((student,index)=>{
    const div=document.createElement("div");
    div.className=`student ${student.color}`;
    div.style.left=student.x+"px";
    div.style.top=student.y+"px";

    const numberDiv=document.createElement("div");
    numberDiv.textContent=student.number||index+1;
    numberDiv.style.fontWeight="bold";
    numberDiv.style.marginBottom="5px";

    const nameDiv=document.createElement("div");
    nameDiv.textContent=student.name;

    div.appendChild(numberDiv);
    div.appendChild(nameDiv);
    canvas.appendChild(div);

    // Drag
    let offsetX, offsetY, isDragging=false;
    div.addEventListener("mousedown", e=>{
      isDragging=true; 
      offsetX=e.clientX-div.offsetLeft; 
      offsetY=e.clientY-div.offsetTop; 
    });
    document.addEventListener("mousemove", e=>{
      if(isDragging){ 
        student.x=e.clientX-offsetX; 
        student.y=e.clientY-offsetY; 
        div.style.left=student.x+"px"; 
        div.style.top=student.y+"px"; 
      }
    });
    document.addEventListener("mouseup", async ()=>{
      if(isDragging){ 
        isDragging=false; 
        await saveStudents();
      }
    });

    // Open modal
    div.addEventListener("click", ()=>{
      selectedStudent=student;
      modalStudentName.textContent=student.name;
      renameInput.value=student.name;
      numberInput.value=student.number||index+1;
      reasonModal.style.display="flex";
    });
  });
}

// Modal color buttons
colorButtons.forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    if(!selectedStudent) return;
    const action=btn.getAttribute("data-action");
    selectedStudent.color=action;
    await saveStudents();
    renderStudents();
    reasonModal.style.display="none";
  });
});

// Rename
renameBtn.addEventListener("click", async ()=>{
  if(!selectedStudent) return;
  const newName = renameInput.value.trim();
  if(newName){
    selectedStudent.name=newName;
    await saveStudents();
    renderStudents();
    modalStudentName.textContent=newName;
  }
});

// Change number
numberBtn.addEventListener("click", async ()=>{
  if(!selectedStudent) return;
  const num = parseInt(numberInput.value);
  if(!isNaN(num)){
    selectedStudent.number=num;
    await saveStudents();
    renderStudents();
  }
});

closeModal.addEventListener("click", ()=>{ reasonModal.style.display="none"; });

loadStudents();
</script>
</body>
</html>
