<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>MusicMojo</title>
  <style>
    :root {
      --green: #22C55F;
      --yellow: #facc15;
      --red: #ef4444;
      --border: #ccc;
    }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header {
      background:#fff;
      border-bottom:2px solid var(--border);
      padding:10px 14px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    header img {
      height: 70px;
      width: auto;
    }
    header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }
    .spacer { flex: 1; }
    .controls { display:flex; align-items:center; gap:10px; }
    select, button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #aaa;
      background: #f7f7f7;
      cursor: pointer;
      font-size: 14px;
    }
    button.primary {
      background: var(--green);
      border-color: var(--green);
      color:#fff;
    }

    #canvasWrap { padding:16px; }
    #canvas {
      position: relative;
      width: 100%;
      height: 600px;
      border: 2px dashed var(--border);
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }

    .student {
      position: absolute;
      width: 120px; height: 84px;
      border-radius: 10px;
      color: #000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      user-select: none;
      cursor: grab;
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
      border: 2px solid #333;
      padding: 6px;
      text-align: center;
      font-weight: 600;
    }
    .student.green { background: var(--green); color: #fff; }
    .student.yellow { background: var(--yellow); color: #000; }
    .student.red { background: var(--red); color: #fff; }
    .num { font-size: 16px; margin-bottom: 4px; }
    .name { font-size: 14px; }

    /* Modal */
    #reasonModal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
      display: none;
      align-items: center; justify-content: center;
      z-index: 1000;
    }
    #modalCard {
      width: 360px; max-width: calc(100% - 40px);
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    #modalHeader { display:flex; align-items:center; justify-content: space-between; }
    #modalHeader h3 { margin:0; font-size: 18px; }
    #modalBody { margin-top: 12px; }
    .reason-grid { display:grid; grid-template-columns: 1fr; gap:8px; }
    .reason-btn {
      padding:10px; border:none; border-radius:8px; font-size:14px; cursor:pointer; width:100%;
    }
    .reason-green { background: var(--green); color:#fff; }
    .reason-yellow { background: var(--yellow); color:#000; }
    .reason-red { background: var(--red); color:#fff; }

    .row { display:flex; gap:8px; align-items:center; margin-top: 10px; }
    .row input[type="text"], .row input[type="number"] {
      flex:1; padding:8px; border:1px solid #bbb; border-radius:8px;
    }
    .close-btn { background:#eee; }
  </style>
</head>
<body>
  <header>
    <img src="MusicMojo logo.png" alt="MusicMojo Logo" onerror="this.style.display='none'">
    <h1>MusicMojo</h1>
    <div class="spacer"></div>
    <div class="controls">
      <label for="classSelect" style="font-weight:600;">Class:</label>
      <select id="classSelect"></select>
      <button id="newClassBtn">+ New Class</button>
      <button id="addStudentBtn" class="primary">+ Add Student</button>
    </div>
  </header>

  <div id="canvasWrap">
    <div id="canvas"></div>
  </div>

  <!-- Modal -->
  <div id="reasonModal">
    <div id="modalCard">
      <div id="modalHeader">
        <h3 id="modalTitle">Edit Student</h3>
        <button id="closeModal" class="close-btn">Close</button>
      </div>

      <div id="modalBody">
        <div class="reason-grid">
          <button class="reason-btn reason-green" data-color="green">Back to Green</button>

          <button class="reason-btn reason-yellow" data-color="yellow" data-reason="Follow Directions">Follow Directions</button>
          <button class="reason-btn reason-yellow" data-color="yellow" data-reason="Be Respectful">Be Respectful</button>
          <button class="reason-btn reason-yellow" data-color="yellow" data-reason="Be Responsible">Be Responsible</button>
          <button class="reason-btn reason-yellow" data-color="yellow" data-reason="Show What You Know">Show What You Know</button>

          <button class="reason-btn reason-red" data-color="red" data-reason="Reflection / Contact Home">Reflection / Contact Home</button>
        </div>

        <div class="row">
          <input type="text" id="renameInput" placeholder="New name">
          <button id="renameBtn">Rename</button>
        </div>

        <div class="row">
          <input type="number" id="numberInput" placeholder="New number">
          <button id="numberBtn">Set Number</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***
     * Data model held in memory:
     * classes = { "Class Name": [ {Class,Name,Number,Color,X,Y}, ... ] }
     */
    let classes = {};
    let currentClass = null;
    let selectedStudent = null;

    // --- Utilities ---
    function debounce(fn, wait=350) {
      let t; 
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), wait);
      };
    }

    function flattenAllStudents(){
      const out = [];
      Object.entries(classes).forEach(([cls, list])=>{
        list.forEach(s => out.push({
          Class: cls,
          Name: s.Name,
          Number: Number(s.Number)||0,
          Color: s.Color || 'green',
          X: Number(s.X)||0,
          Y: Number(s.Y)||0
        }));
      });
      return out;
    }

    const saveStudents = debounce(function(){
      const students = flattenAllStudents();
      google.script.run
        .withSuccessHandler(() => console.log('Saved', new Date().toLocaleTimeString()))
        .withFailureHandler(err => console.error('Save failed', err))
        .saveStudents(students);
    }, 300);

    // --- Load from server ---
    function loadStudents(){
      google.script.run
        .withSuccessHandler((data)=>{
          classes = {};
          if (Array.isArray(data)) {
            data.forEach(s=>{
              if(!classes[s.Class]) classes[s.Class] = [];
              classes[s.Class].push({...s});
            });
          }
          // Default class if none
          if (Object.keys(classes).length === 0) {
            classes['Class 1'] = [];
            for (let i=1;i<=14;i++) {
              classes['Class 1'].push({
                Class: 'Class 1',
                Name: 'Student ' + i,
                Number: i,
                Color: 'green',
                X: 30 + ((i-1)%7)*135,
                Y: 30 + Math.floor((i-1)/7)*120
              });
            }
            currentClass = 'Class 1';
            buildClassDropdown();
            render();
            saveStudents(); // persist default
            return;
          }
          // Set current class
          currentClass = Object.keys(classes)[0];
          buildClassDropdown();
          render();
        })
        .withFailureHandler(err => console.error('Load failed', err))
        .getStudents();
    }

    // --- UI: class dropdown & controls ---
    function buildClassDropdown(){
      const sel = document.getElementById('classSelect');
      sel.innerHTML = '';
      Object.keys(classes).forEach(cls=>{
        const opt = document.createElement('option');
        opt.value = cls; opt.textContent = cls;
        sel.appendChild(opt);
      });
      if (currentClass) sel.value = currentClass;
      sel.onchange = e => { currentClass = e.target.value; render(); };
    }

    document.getElementById('newClassBtn').onclick = () => {
      const name = prompt('New class name:');
      if (!name) return;
      if (classes[name]) { alert('Class already exists'); return; }
      let count = parseInt(prompt('How many students?', '14'), 10);
      if (isNaN(count) || count < 0) count = 0;
      classes[name] = [];
      for (let i=1;i<=count;i++){
        classes[name].push({
          Class: name, Name: 'Student '+i, Number: i,
          Color: 'green',
          X: 30 + ((i-1)%7)*135,
          Y: 30 + Math.floor((i-1)/7)*120
        });
      }
      currentClass = name;
      buildClassDropdown();
      render();
      saveStudents();
    };

    document.getElementById('addStudentBtn').onclick = () => {
      if (!currentClass) return alert('Pick a class first');
      const list = classes[currentClass];
      const n = list.length + 1;
      const s = {
        Class: currentClass,
        Name: 'New Student',
        Number: n,
        Color: 'green',
        X: 40 + (Math.random()* (document.getElementById('canvas').clientWidth - 160)),
        Y: 40 + (Math.random()* (document.getElementById('canvas').clientHeight - 120))
      };
      list.push(s);
      render();
      saveStudents();
    };

    // --- Render students & free-form dragging ---
    function render(){
      const canvas = document.getElementById('canvas');
      canvas.innerHTML = '';
      if (!currentClass || !classes[currentClass]) return;

      classes[currentClass].forEach((s, idx) => {
        const el = document.createElement('div');
        el.className = 'student ' + (s.Color === 'red' ? 'red' : s.Color === 'yellow' ? 'yellow' : 'green');
        el.style.left = (Number(s.X)||0) + 'px';
        el.style.top  = (Number(s.Y)||0) + 'px';

        el.innerHTML = `
          <div class="num">${s.Number || idx+1}</div>
          <div class="name">${s.Name}</div>
        `;

        // Dragging
        let dragging = false;
        let startX=0, startY=0, origX=0, origY=0;

        el.addEventListener('mousedown', (e)=>{
          dragging = true;
          el.style.cursor = 'grabbing';
          startX = e.clientX;
          startY = e.clientY;
          origX = Number(s.X)||0;
          origY = Number(s.Y)||0;
          e.stopPropagation();
          e.preventDefault();
        });

        document.addEventListener('mousemove', (e)=>{
          if (!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          const newX = Math.max(0, Math.min(origX + dx, canvas.clientWidth - el.offsetWidth));
          const newY = Math.max(0, Math.min(origY + dy, canvas.clientHeight - el.offsetHeight));
          s.X = newX; s.Y = newY;
          el.style.left = newX + 'px';
          el.style.top  = newY + 'px';
        });

        document.addEventListener('mouseup', ()=>{
          if (dragging) {
            dragging = false;
            el.style.cursor = 'grab';
            saveStudents(); // persist new X/Y
          }
        });

        // Double-click to open modal
        el.addEventListener('dblclick', ()=>{
          selectedStudent = s;
          openModal(s);
        });

        canvas.appendChild(el);
      });
    }

    // --- Modal logic ---
    const modal = document.getElementById('reasonModal');
    const modalTitle = document.getElementById('modalTitle');
    const renameInput = document.getElementById('renameInput');
    const numberInput = document.getElementById('numberInput');

    function openModal(student){
      modalTitle.textContent = student.Name;
      renameInput.value = student.Name || '';
      numberInput.value = student.Number || '';
      modal.style.display = 'flex';
    }
    document.getElementById('closeModal').onclick = ()=> modal.style.display = 'none';

    // Color buttons (Green, 4x Yellow reasons, Red)
    document.querySelectorAll('.reason-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (!selectedStudent) return;
        const color = btn.dataset.color;
        selectedStudent.Color = color; // 'green' | 'yellow' | 'red'
        // (Optional: you could also log btn.dataset.reason somewhere)
        render();
        saveStudents();
        modal.style.display = 'none';
      });
    });

    // Rename
    document.getElementById('renameBtn').onclick = ()=>{
      if (!selectedStudent) return;
      const v = renameInput.value.trim();
      if (!v) return;
      selectedStudent.Name = v;
      modalTitle.textContent = v;
      render();
      saveStudents();
    };

    // Renumber
    document.getElementById('numberBtn').onclick = ()=>{
      if (!selectedStudent) return;
      const n = parseInt(numberInput.value, 10);
      if (isNaN(n) || n < 1) return;
      selectedStudent.Number = n;
      render();
      saveStudents();
    };

    // Kick off
    window.addEventListener('load', loadStudents);
  </script>
</body>
</html>
