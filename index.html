<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MusicMojo</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  header { display: flex; align-items: center; margin-bottom: 10px; }
  header img { height: 100px; margin-right: 20px; }
  header h1 { font-size: 32px; margin: 0; }
  #classSelector { margin-bottom: 20px; }
  #canvas { position: relative; width: 100%; height: 600px; border: 2px dashed #ccc; }
  .student { width: 100px; height: 80px; background-color: #22C55F; color: white; display: flex; justify-content: center; align-items: center; cursor: grab; user-select: none; position: absolute; flex-direction: column; border-radius: 8px; font-size: 18px; text-align: center; padding: 10px; }
  .yellow { background-color: #facc15; color: #000; }
  .red { background-color: #ef4444; color: #fff; }
  button { margin-top: 20px; padding: 8px 14px; cursor: pointer; }
  .actionBtn { background-color: #22C55F; color: white; border: none; padding: 8px 14px; margin-left: 8px; border-radius: 6px; cursor: pointer; font-size: 14px; }
  .actionBtn:hover { background-color: #16a34a; }

  /* Modal styles */
  #reasonModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; }
  #reasonModalContent { background: #fff; padding: 20px; border-radius: 12px; text-align: center; width: 300px; }
  .reasonBtn { display: block; margin: 10px auto; width: 220px; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; color: #fff; }
  .greenBtn { background: #22C55F; color: #fff; }
  .yellowBtn { background: #facc15; color: #000; }
  .redBtn { background: #ef4444; color: #fff; }
</style>
</head>
<body>
<header>
  <img src="MusicMojo logo.png" alt="MusicMojo Logo">
  <h1>MusicMojo</h1>
</header>

<label for="classSelector">Select Class:</label>
<select id="classSelector"></select>
<button id="renameClass" class="actionBtn">✏️ Rename Class</button>
<button id="newClass" class="actionBtn">+ New Class</button>
<button id="addStudent" class="actionBtn">+ Add Student</button>
<button id="exportLog" class="actionBtn">Export Log (CSV)</button>

<div id="canvas"></div>

<!-- Modal for actions -->
<div id="reasonModal">
  <div id="reasonModalContent">
    <h3>Select Action</h3>
    <button class="reasonBtn greenBtn" data-action="green">Back to Green</button>
    <button class="reasonBtn yellowBtn" data-action="yellow">Follow Directions</button>
    <button class="reasonBtn yellowBtn" data-action="yellow">Be Respectful</button>
    <button class="reasonBtn yellowBtn" data-action="yellow">Be Responsible</button>
    <button class="reasonBtn yellowBtn" data-action="yellow">Show What You Know</button>
    <button class="reasonBtn redBtn" data-action="red">Reflection / Contact Home</button>
  </div>
</div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDsV5k4-TzsLFVAFv5aNVi2bcEFh4A7uIE",
  authDomain: "musicmojo-5113d.firebaseapp.com",
  projectId: "musicmojo-5113d",
  storageBucket: "musicmojo-5113d.firebasestorage.app",
  messagingSenderId: "442468017699",
  appId: "1:442468017699:web:7c670de3485fe5961e3396",
  measurementId: "G-GXV000M8NL"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const classSelector = document.getElementById("classSelector");
const renameClassBtn = document.getElementById("renameClass");
const newClassBtn = document.getElementById("newClass");
const addStudentBtn = document.getElementById("addStudent");
const canvas = document.getElementById("canvas");
const reasonModal = document.getElementById("reasonModal");
const reasonButtons = document.querySelectorAll(".reasonBtn");
const exportBtn = document.getElementById("exportLog");

let classes = {};
let currentClass = "";
let pendingStudent = null;
let log = [];

// Load classes from Firestore
async function loadClasses() {
  const snapshot = await db.collection("classes").get();
  classes = {};
  snapshot.forEach(doc => classes[doc.id] = doc.data().students || []);
  if (Object.keys(classes).length === 0) {
    classes["Class 1"] = [];
    await db.collection("classes").doc("Class 1").set({ students: [] });
  }
  buildDropdown();
}

function buildDropdown() {
  classSelector.innerHTML = "";
  Object.keys(classes).forEach(cls => {
    const option = document.createElement("option");
    option.value = cls;
    option.textContent = cls;
    classSelector.appendChild(option);
  });
  currentClass = classSelector.value || Object.keys(classes)[0];
  renderStudents();
}

classSelector.addEventListener("change", () => {
  currentClass = classSelector.value;
  renderStudents();
});

renameClassBtn.addEventListener("click", async () => {
  const newName = prompt("Enter new class name:", currentClass);
  if (!newName || classes[newName]) return alert("Invalid or duplicate class name!");
  classes[newName] = classes[currentClass];
  delete classes[currentClass];
  await db.collection("classes").doc(newName).set({ students: classes[newName] });
  await db.collection("classes").doc(currentClass).delete();
  currentClass = newName;
  buildDropdown();
});

newClassBtn.addEventListener("click", async () => {
  const name = prompt("Enter name for new class:");
  if (!name || classes[name]) return alert("Invalid or duplicate class name!");
  classes[name] = [];
  currentClass = name;
  buildDropdown();
  await db.collection("classes").doc(name).set({ students: [] });
  alert(`Class "${name}" created!`);
});

addStudentBtn.addEventListener("click", async () => {
  const students = classes[currentClass];
  const newStudent = { name: "New Student", color: "green", x: 50, y: 50 };
  students.push(newStudent);
  await db.collection("classes").doc(currentClass).set({ students });
  renderStudents();
});

function renderStudents() {
  canvas.innerHTML = "";
  const students = classes[currentClass] || [];
  students.forEach((student, index) => {
    const div = document.createElement("div");
    div.className = `student ${student.color}`;
    div.style.left = student.x + "px";
    div.style.top = student.y + "px";
    div.innerHTML = `<div style="font-weight:bold">${index+1}</div><div>${student.name}</div>`;
    canvas.appendChild(div);

    // Dragging
    let offsetX, offsetY, isDragging = false;
    div.addEventListener("mousedown", e => {
      isDragging = true;
      offsetX = e.clientX - div.offsetLeft;
      offsetY = e.clientY - div.offsetTop;
    });
    document.addEventListener("mousemove", e => {
      if (isDragging) {
        student.x = e.clientX - offsetX;
        student.y = e.clientY - offsetY;
        div.style.left = student.x + "px";
        div.style.top = student.y + "px";
      }
    });
    document.addEventListener("mouseup", async () => {
      if (isDragging) {
        isDragging = false;
        await db.collection("classes").doc(currentClass).set({ students });
      }
    });

    // Click to open modal
    div.addEventListener("click", () => {
      pendingStudent = student;
      reasonModal.style.display = "flex";
    });
  });
}

// Modal buttons
reasonButtons.forEach(btn => {
  btn.addEventListener("click", async () => {
    if (!pendingStudent) return;
    const action = btn.getAttribute("data-action");
    pendingStudent.color = action;
    log.push({ student: pendingStudent.name, color: action, reason: btn.textContent, time: new Date().toLocaleString() });
    pendingStudent = null;
    reasonModal.style.display = "none";
    await db.collection("classes").doc(currentClass).set({ students: classes[currentClass] });
    renderStudents();
  });
});

reasonModal.addEventListener("click", e => {
  if (e.target === reasonModal) reasonModal.style.display = "none";
});

// Export log
exportBtn.addEventListener("click", () => {
  if (log.length === 0) return alert("No actions logged yet!");
  let csv = "Student,Color,Reason,Time\n";
  log.forEach(entry => {
    csv += `"${entry.student}","${entry.color}","${entry.reason}","${entry.time}"\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `log_${currentClass}.csv`;
  a.click();
  URL.revokeObjectURL(url);
});

loadClasses();
</script>
</body>
</html>
