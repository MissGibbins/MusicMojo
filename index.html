<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Classroom Manager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f9fafb;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #1d4ed8;
      color: white;
      padding: 10px 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    header img {
      height: 40px;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    .controls {
      display: flex;
      gap: 10px;
    }

    .controls button {
      background: #3b82f6;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .controls button:hover {
      background: #2563eb;
    }

    #classSelect {
      padding: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #canvas {
      position: relative;
      height: calc(100vh - 70px);
      background: white;
      overflow: hidden;
    }

    .studentBox {
      background-color: #22C55F;
      color: white;
      padding: 8px;
      border-radius: 10px;
      width: 110px;
      text-align: center;
      position: absolute;
      cursor: move;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .studentNumber, .studentName {
      width: 90%;
      margin: 4px auto;
      padding: 2px;
      border: none;
      border-radius: 4px;
      background: rgba(255,255,255,0.2);
      color: white;
      text-align: center;
    }

    .studentNumber:focus, .studentName:focus {
      outline: 2px solid white;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .modal-content h3 {
      margin-bottom: 15px;
    }

    .modal-buttons button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      color: white;
    }

    .green { background: #22C55F; }
    .yellow { background: #eab308; }
    .red { background: #dc2626; }

    .modal-buttons button:hover {
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <header>
    <h1>Classroom Manager</h1>
    <div class="controls">
      <select id="classSelect"></select>
      <button onclick="renameClass()">Rename Class</button>
      <button onclick="addStudent()">+ Student</button>
      <button onclick="makeGroups()">Make Random Groups</button>
      <button onclick="exportCSV()">Export Log</button>
    </div>
  </header>

  <div id="canvas"></div>

  <!-- Modal -->
  <div id="statusModal" class="modal">
    <div class="modal-content">
      <h3>Change Status</h3>
      <div class="modal-buttons">
        <button class="green" onclick="setStatus('green')">Back to Green</button>
        <button class="yellow" onclick="setStatus('yellow1')">Reason 1</button>
        <button class="yellow" onclick="setStatus('yellow2')">Reason 2</button>
        <button class="yellow" onclick="setStatus('yellow3')">Reason 3</button>
        <button class="yellow" onclick="setStatus('yellow4')">Reason 4</button>
        <button class="red" onclick="setStatus('red')">Red</button>
      </div>
    </div>
  </div>

  <script>
    let currentClass = "Class 1";
    let classes = {};
    let studentCount = 0;
    let activeStudent = null;
    let log = [];

    const classSelect = document.getElementById("classSelect");
    const canvas = document.getElementById("canvas");
    const modal = document.getElementById("statusModal");

    // Initialize classes
    for (let i = 1; i <= 20; i++) {
      classes[`Class ${i}`] = [];
      let option = document.createElement("option");
      option.value = `Class ${i}`;
      option.textContent = `Class ${i}`;
      classSelect.appendChild(option);
    }
    classSelect.value = currentClass;

    function saveData() {
      localStorage.setItem("classes", JSON.stringify(classes));
      localStorage.setItem("log", JSON.stringify(log));
    }

    function loadData() {
      const savedClasses = localStorage.getItem("classes");
      const savedLog = localStorage.getItem("log");
      if (savedClasses) classes = JSON.parse(savedClasses);
      if (savedLog) log = JSON.parse(savedLog);
      renderClass();
    }

    function renderClass() {
      canvas.innerHTML = "";
      studentCount = classes[currentClass].length;
      classes[currentClass].forEach(st => createStudentBox(st));
    }

    function addStudent() {
      studentCount++;
      const student = {
        id: Date.now(),
        number: studentCount,
        name: "",
        x: 20, y: 20,
        status: "green"
      };
      classes[currentClass].push(student);
      createStudentBox(student);
      saveData();
    }

    function createStudentBox(student) {
      const div = document.createElement("div");
      div.className = "studentBox";
      div.style.left = student.x + "px";
      div.style.top = student.y + "px";
      div.dataset.id = student.id;

      const numberInput = document.createElement("input");
      numberInput.type = "number";
      numberInput.className = "studentNumber";
      numberInput.value = student.number;
      numberInput.onchange = () => {
        student.number = numberInput.value;
        saveData();
      };

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.className = "studentName";
      nameInput.placeholder = "Student Name";
      nameInput.value = student.name;
      nameInput.onchange = () => {
        student.name = nameInput.value;
        saveData();
      };

      div.appendChild(numberInput);
      div.appendChild(nameInput);

      div.onclick = (e) => {
        if (e.target.tagName === "INPUT") return;
        activeStudent = student;
        modal.style.display = "flex";
      };

      makeDraggable(div, student);
      canvas.appendChild(div);
      applyStatus(div, student.status);
    }

    function makeDraggable(el, student) {
      let offsetX, offsetY;
      el.onmousedown = (e) => {
        if (e.target.tagName === "INPUT") return;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        document.onmousemove = (e2) => {
          el.style.left = e2.pageX - offsetX + "px";
          el.style.top = e2.pageY - offsetY + "px";
          student.x = e2.pageX - offsetX;
          student.y = e2.pageY - offsetY;
        };
        document.onmouseup = () => {
          document.onmousemove = null;
          saveData();
        };
      };
    }

    function applyStatus(el, status) {
      if (status.startsWith("yellow")) {
        el.style.background = "#eab308";
      } else if (status === "red") {
        el.style.background = "#dc2626";
      } else {
        el.style.background = "#22C55F";
      }
    }

    function setStatus(status) {
      if (!activeStudent) return;
      activeStudent.status = status;
      log.push({
        class: currentClass,
        student: activeStudent.name || "(unnamed)",
        number: activeStudent.number,
        status,
        time: new Date().toLocaleString()
      });
      saveData();
      renderClass();
      modal.style.display = "none";
    }

    function renameClass() {
      const newName = prompt("Enter new class name:", currentClass);
      if (newName) {
        classes[newName] = classes[currentClass];
        delete classes[currentClass];
        currentClass = newName;
        classSelect.innerHTML = "";
        for (let key in classes) {
          let option = document.createElement("option");
          option.value = key;
          option.textContent = key;
          classSelect.appendChild(option);
        }
        classSelect.value = currentClass;
        saveData();
      }
    }

    classSelect.onchange = () => {
      currentClass = classSelect.value;
      renderClass();
    };

    function makeGroups() {
      let choice = prompt("Enter number of groups OR students per group (e.g. 'groups:4' or 'size:3')");
      if (!choice) return;
      let students = [...classes[currentClass]];
      students = students.sort(() => Math.random() - 0.5);

      let groups = [];
      if (choice.startsWith("groups:")) {
        let g = parseInt(choice.split(":")[1]);
        for (let i = 0; i < g; i++) groups.push([]);
        students.forEach((s, i) => groups[i % g].push(s));
      } else if (choice.startsWith("size:")) {
        let size = parseInt(choice.split(":")[1]);
        for (let i = 0; i < Math.ceil(students.length/size); i++) groups.push([]);
        students.forEach((s, i) => groups[Math.floor(i/size)].push(s));
      }

      alert("Groups:\n" + groups.map((g,i)=>`Group ${i+1}: ${g.map(s=>s.name||"(unnamed)").join(", ")}`).join("\n"));
    }

    function exportCSV() {
      let csv = "Class,Number,Name,Status,Time\n";
      log.forEach(l => {
        csv += `${l.class},${l.number},${l.student},${l.status},${l.time}\n`;
      });
      let blob = new Blob([csv], {type: "text/csv"});
      let link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "log.csv";
      link.click();
    }

    window.onload = loadData;
    window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };
  </script>
</body>
</html>
