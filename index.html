<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MusicMojo</title>
<style>
body { font-family: sans-serif; margin:0; padding:0; }
header { background:white; padding:10px; display:flex; align-items:center; border-bottom:2px solid #ccc; }
header img { height:80px; margin-right:15px; }
header select, header button { margin-right:10px; padding:6px 12px; border-radius:6px; border:1px solid #aaa; cursor:pointer; }
#canvas { position:relative; width:100%; height:600px; border:2px dashed #ccc; margin-top:10px; }
.student { width:100px; height:80px; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:8px; cursor:grab; position:absolute; font-weight:bold; user-select:none; }
.yellow { background:#facc15; color:#000; }
.red { background:#ef4444; color:#fff; }
.green { background:#22C55F; color:#fff; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:white; padding:20px; border-radius:12px; width:320px; text-align:center; }
.modal-content input { width:90%; padding:5px; margin:5px 0; }
.modal-content button { margin:5px; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
.greenBtn{background:#22C55F;color:#fff;}
.yellowBtn{background:#facc15;color:#000;}
.redBtn{background:#ef4444;color:#fff;}
</style>
</head>
<body>

<header>
<img src="MusicMojo logo.png" alt="MusicMojo Logo">
<select id="classSelect"></select>
<button onclick="newClass()">New Class</button>
<button onclick="addStudent()">Add Student</button>
<button onclick="saveStudents()">Save</button>
</header>

<div id="canvas"></div>

<!-- Modal -->
<div id="studentModal" class="modal">
  <div class="modal-content">
    <h3 id="modalStudentName"></h3>
    <button class="greenBtn" onclick="setColor('green')">Green</button>
    <button class="yellowBtn" onclick="setColor('yellow')">Follow Directions</button>
    <button class="yellowBtn" onclick="setColor('yellow')">Be Respectful</button>
    <button class="yellowBtn" onclick="setColor('yellow')">Be Responsible</button>
    <button class="yellowBtn" onclick="setColor('yellow')">Show What You Know</button>
    <button class="redBtn" onclick="setColor('red')">Reflection / Contact Home</button>
    <div>
      <input type="text" id="renameInput" placeholder="New Name">
      <button onclick="renameStudent()">Rename</button>
    </div>
    <div>
      <input type="number" id="numberInput" placeholder="New Number">
      <button onclick="renumberStudent()">Set Number</button>
    </div>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrJLtI31KFFh-8PFA7-5qCpM8aL-FHXTp4TIy6KbCgeQkYgacF_YzecyGuGFh6BUUk/exec"; 
let classes = {};
let currentClass = "";
let selectedStudent = null;

// Load students
async function loadStudents(){
  try {
    const data = await fetch(SCRIPT_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({type:"getStudents"})
    }).then(r=>r.json());

    classes = {};
    data.forEach(s=>{
      if(!classes[s.Class]) classes[s.Class]=[];
      classes[s.Class].push(s);
    });

    if(!currentClass && Object.keys(classes).length>0) currentClass=Object.keys(classes)[0];
    populateClassSelect();
    renderStudents();
  } catch(err){ console.error(err); }
}

// Save students
async function saveStudents(){
  let all = [];
  Object.keys(classes).forEach(cls=>{
    classes[cls].forEach(s=>all.push({Class:cls,...s}));
  });
  await fetch(SCRIPT_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({type:"saveStudents", students:all})
  });
}

// Populate dropdown
function populateClassSelect(){
  const sel = document.getElementById("classSelect");
  sel.innerHTML="";
  Object.keys(classes).forEach(c=>{
    const opt=document.createElement("option");
    opt.value=c; opt.textContent=c;
    if(c===currentClass) opt.selected=true;
    sel.appendChild(opt);
  });
}

// Switch class
document.getElementById("classSelect").addEventListener("change", e=>{
  currentClass=e.target.value;
  renderStudents();
});

// New class
function newClass(){
  const name = prompt("Enter class name:");
  if(!name || classes[name]) return;
  classes[name]=[];
  currentClass=name;
  populateClassSelect();
  renderStudents();
  saveStudents();
}

// Add student
function addStudent(){
  if(!currentClass) return alert("Select class first");
  const list = classes[currentClass];
  const student = {Name:"New Student",Number:list.length+1,Color:"green",X:50,Y:50};
  list.push(student);
  renderStudents();
  saveStudents();
}

// Render students
function renderStudents(){
  const canvas = document.getElementById("canvas");
  canvas.innerHTML="";
  if(!currentClass || !classes[currentClass]) return;
  classes[currentClass].forEach((s,i)=>{
    const div = document.createElement("div");
    div.className="student "+s.Color;
    div.style.left=s.X+"px";
    div.style.top=s.Y+"px";
    div.textContent=s.Name;
    div.addEventListener("dblclick", ()=>{
      selectedStudent=s;
      document.getElementById("modalStudentName").textContent=s.Name;
      document.getElementById("renameInput").value=s.Name;
      document.getElementById("numberInput").value=s.Number;
      document.getElementById("studentModal").style.display="flex";
    });
    // Dragging
    let offsetX,offsetY,isDragging=false;
    div.addEventListener("mousedown", e=>{
      isDragging=true;
      offsetX=e.clientX-div.offsetLeft;
      offsetY=e.clientY-div.offsetTop;
    });
    document.addEventListener("mousemove", e=>{
      if(isDragging){
        s.X=e.clientX-offsetX;
        s.Y=e.clientY-offsetY;
        div.style.left=s.X+"px";
        div.style.top=s.Y+"px";
      }
    });
    document.addEventListener("mouseup", e=>{
      if(isDragging){
        isDragging=false;
        saveStudents();
      }
    });
    canvas.appendChild(div);
  });
}

// Modal functions
function closeModal(){ document.getElementById("studentModal").style.display="none"; }
function setColor(color){ if(!selectedStudent) return; selectedStudent.Color=color; saveStudents(); renderStudents(); closeModal(); }
function renameStudent(){ if(!selectedStudent) return; selectedStudent.Name=document.getElementById("renameInput").value; saveStudents(); renderStudents(); closeModal(); }
function renumberStudent(){ if(!selectedStudent) return; selectedStudent.Number=parseInt(document.getElementById("numberInput").value)||selectedStudent.Number; saveStudents(); renderStudents(); }

// Start
loadStudents();
</script>
</body>
</html>
