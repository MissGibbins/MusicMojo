<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MusicMojo Classroom</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; }
    #student-area { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
    .student {
      width: 100px; height: 100px; background: green; color: white;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      border-radius: 10px; cursor: pointer; user-select: none;
    }
    .yellow { background: gold; color: black; }
    .red { background: crimson; }
    #modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;
    }
    #modalContent {
      background: white; padding: 20px; border-radius: 10px; text-align: center;
    }
    button { margin: 5px; }
  </style>
</head>
<body>
  <header>
    <div>
      <select id="classDropdown"></select>
      <button id="newClassBtn">+ New Class</button>
    </div>
  </header>

  <div id="student-area"></div>

  <div id="modal">
    <div id="modalContent">
      <h3 id="modalTitle"></h3>
      <button data-color="green">‚úÖ Green</button>
      <button data-color="yellow">‚ö†Ô∏è Yellow</button>
      <button data-color="red">‚õî Red</button>
      <br><br>
      <button id="renameBtn">‚úèÔ∏è Rename</button>
      <button id="renumberBtn">üî¢ Change Number</button>
      <br><br>
      <button id="closeModal">Close</button>
    </div>
  </div>

  <script>
    let classes = {};  
    let currentClass = null;
    let selectedStudent = null;

    // Google Sheets API endpoint
    const API_URL = "https://script.google.com/macros/s/AKfycbyxJP348mWtExUVYAuttE0BMQPWnQESzUIH0kpir0XSOFQWE8DmXMwCuvIFye1_RlDE/exec";

    async function apiPost(data) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      return res.json();
    }

    async function loadStudents() {
      try {
        const data = await apiPost({action: "load"});
        classes = data.classes || {};
        if (Object.keys(classes).length > 0) {
          currentClass = Object.keys(classes)[0];
        }
        buildDropdown();
      } catch (e) {
        console.error("Failed to load students:", e);
      }
    }

    async function saveStudents() {
      await apiPost({action: "save", classes});
    }

    function buildDropdown() {
      const dropdown = document.getElementById("classDropdown");
      dropdown.innerHTML = "";
      for (const c in classes) {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        if (c === currentClass) opt.selected = true;
        dropdown.appendChild(opt);
      }
      renderStudents();
    }

    function renderStudents() {
      const area = document.getElementById("student-area");
      area.innerHTML = "";
      if (!currentClass || !classes[currentClass]) return;
      for (const student of classes[currentClass]) {
        const div = document.createElement("div");
        div.className = "student " + student.color;
        div.innerHTML = `<strong>${student.number}</strong><br>${student.name}`;
        div.addEventListener("click", ()=> openModal(student));
        area.appendChild(div);
      }
    }

    function openModal(student) {
      selectedStudent = student;
      document.getElementById("modalTitle").textContent = student.name;
      document.getElementById("modal").style.display = "flex";
    }

    document.querySelectorAll("#modalContent button[data-color]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if (!selectedStudent) return;
        selectedStudent.color = btn.dataset.color;
        await saveStudents();
        renderStudents();
      });
    });

    document.getElementById("renameBtn").addEventListener("click", async ()=>{
      if (!selectedStudent) return;
      const newName = prompt("Enter new name:", selectedStudent.name);
      if (newName) {
        selectedStudent.name = newName;
        await saveStudents();
        renderStudents();
      }
    });

    document.getElementById("renumberBtn").addEventListener("click", async ()=>{
      if (!selectedStudent) return;
      const newNumber = prompt("Enter new number:", selectedStudent.number);
      if (newNumber) {
        selectedStudent.number = newNumber;
        await saveStudents();
        renderStudents();
      }
    });

    document.getElementById("closeModal").addEventListener("click", ()=>{
      document.getElementById("modal").style.display = "none";
      selectedStudent = null;
    });

    document.getElementById("classDropdown").addEventListener("change", e=>{
      currentClass = e.target.value;
      renderStudents();
    });

    document.getElementById("newClassBtn").addEventListener("click", async ()=>{
      const name = prompt("New class name:");
      if(!name || classes[name]) return alert("Invalid or duplicate class name!");

      const count = parseInt(prompt("How many students in this class?"), 10);
      if(isNaN(count) || count <= 0) return alert("Invalid number of students!");

      classes[name] = [];
      for(let i=1; i<=count; i++){
        classes[name].push({name:"Student "+i, number:i, color:"green", x:50+i*10, y:50});
      }

      currentClass = name;
      buildDropdown();
      await saveStudents();
    });

    loadStudents();
  </script>
</body>
</html>
