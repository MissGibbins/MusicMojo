<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Class Manager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    header {
      background: #22C55F;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    #controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px;
    }
    button, select {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    button {
      background: #22C55F;
      color: white;
    }
    button:hover {
      background: #16A34A;
    }
    #studentCanvas {
      position: relative;
      width: 100%;
      height: calc(100vh - 150px);
      border: 2px dashed #ccc;
      background: white;
      overflow: hidden;
    }
    .student {
      position: absolute;
      background: #22C55F;
      color: white;
      padding: 8px;
      border-radius: 8px;
      cursor: move;
      width: 120px;
      text-align: center;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      user-select: none;
    }
    .studentNumber {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .studentName {
      font-size: 16px;
      font-weight: bold;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      text-align: center;
    }
    .modal button {
      display: block;
      width: 100%;
      margin: 6px 0;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
    }
    .btn-green { background: #22C55F; color: white; }
    .btn-yellow { background: #EAB308; color: black; }
    .btn-red { background: #DC2626; color: white; }
  </style>
</head>
<body>
  <header>
    Class Manager
  </header>

  <div id="controls">
    <select id="classSelect"></select>
    <button onclick="renameClass()">Rename Class</button>
    <button onclick="addStudent()">+ Student</button>
    <button onclick="makeRandomGroups()">Make Random Groups</button>
  </div>

  <div id="studentCanvas"></div>

  <!-- Modal -->
  <div id="statusModal" class="modal">
    <div class="modal-content">
      <h3>Change Status</h3>
      <button class="btn-green" onclick="setStatus('green')">Back to Green</button>
      <button class="btn-yellow" onclick="setStatus('yellow1')">Reason 1</button>
      <button class="btn-yellow" onclick="setStatus('yellow2')">Reason 2</button>
      <button class="btn-yellow" onclick="setStatus('yellow3')">Reason 3</button>
      <button class="btn-yellow" onclick="setStatus('yellow4')">Reason 4</button>
      <button class="btn-red" onclick="setStatus('red')">Red</button>
    </div>
  </div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbwCGcuFUhojhE7tLOXW0ANd_GzYYvJjShDQVyCJx_1nBzpW4tD5148CBySYPauop2le/exec";
    let classes = {};
    let currentClass = "Class 1";
    let dragged = null;
    let currentStudent = null;

    async function loadData() {
      const res = await fetch(apiUrl);
      const data = await res.json();
      classes = data.classes || { "Class 1": [] };
      currentClass = Object.keys(classes)[0];
      renderClassOptions();
      renderStudents();
    }

    async function saveData() {
      await fetch(apiUrl, {
        method: "POST",
        body: JSON.stringify({ classes }),
        headers: { "Content-Type": "application/json" }
      });
    }

    function renderClassOptions() {
      const select = document.getElementById("classSelect");
      select.innerHTML = "";
      Object.keys(classes).forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        if (c === currentClass) opt.selected = true;
        select.appendChild(opt);
      });
      select.onchange = e => {
        currentClass = e.target.value;
        renderStudents();
      };
    }

    function renderStudents() {
      const canvas = document.getElementById("studentCanvas");
      canvas.innerHTML = "";
      classes[currentClass].forEach((student, i) => {
        const div = document.createElement("div");
        div.className = "student";
        div.style.left = student.x + "px";
        div.style.top = student.y + "px";
        div.style.background = getColor(student.status);
        div.dataset.index = i;
        div.innerHTML = `
          <div class="studentNumber">${i+1}</div>
          <div class="studentName">${student.name}</div>
        `;
        div.onclick = () => { currentStudent = student; openModal(); };
        makeDraggable(div, student);
        canvas.appendChild(div);
      });
    }

    function makeDraggable(el, student) {
      let offsetX, offsetY;
      el.onmousedown = e => {
        dragged = el;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      };
      document.onmousemove = e => {
        if (dragged) {
          dragged.style.left = (e.pageX - offsetX) + "px";
          dragged.style.top = (e.pageY - offsetY) + "px";
        }
      };
      document.onmouseup = () => {
        if (dragged) {
          const i = dragged.dataset.index;
          student.x = parseInt(dragged.style.left);
          student.y = parseInt(dragged.style.top);
          saveData();
          dragged = null;
        }
      };
    }

    function addStudent() {
      const name = prompt("Student name?");
      if (!name) return;
      classes[currentClass].push({ name, x: 50, y: 50, status: "green" });
      renderStudents();
      saveData();
    }

    function renameClass() {
      const newName = prompt("New class name?", currentClass);
      if (!newName) return;
      classes[newName] = classes[currentClass];
      delete classes[currentClass];
      currentClass = newName;
      renderClassOptions();
      saveData();
    }

    function getColor(status) {
      if (status === "green") return "#22C55F";
      if (status.startsWith("yellow")) return "#EAB308";
      if (status === "red") return "#DC2626";
      return "#22C55F";
    }

    function openModal() {
      document.getElementById("statusModal").style.display = "block";
    }
    function closeModal() {
      document.getElementById("statusModal").style.display = "none";
    }
    function setStatus(status) {
      currentStudent.status = status;
      renderStudents();
      saveData();
      closeModal();
    }

    function makeRandomGroups() {
      const method = prompt("Type 'groups' to set number of groups, or 'size' for students per group:");
      if (!method) return;
      let groups = [];
      let students = [...classes[currentClass]];
      students = students.sort(() => Math.random() - 0.5);
      if (method === "groups") {
        const num = parseInt(prompt("How many groups?"));
        for (let i=0; i<num; i++) groups.push([]);
        students.forEach((s, i) => groups[i%num].push(s.name));
      } else {
        const size = parseInt(prompt("How many students per group?"));
        for (let i=0; i<Math.ceil(students.length/size); i++) {
          groups.push(students.slice(i*size, i*size+size).map(s=>s.name));
        }
      }
      alert(groups.map((g,i)=>`Group ${i+1}: ${g.join(", ")}`).join("\n"));
    }

    loadData();
  </script>
</body>
</html>
